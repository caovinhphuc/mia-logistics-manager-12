#!/bin/bash

# ============================================================
# GOOGLE SHEETS API SETUP SCRIPT
# HÆ°á»›ng dáº«n chi tiáº¿t cÃ i Ä‘áº·t & cáº¥u hÃ¬nh Google Sheets API
# ============================================================

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}"
cat << "EOF"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                           â•‘
â•‘         ğŸ“Š GOOGLE SHEETS API SETUP WIZARD ğŸ“Š             â•‘
â•‘                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
echo -e "${NC}\n"

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}Wizard nÃ y sáº½ hÆ°á»›ng dáº«n báº¡n setup Google Sheets API${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

# Step 1: Open Google Cloud Console
echo -e "${YELLOW}â”â”â” BÆ¯á»šC 1: Táº¡o Google Cloud Project â”â”â”${NC}\n"
echo -e "${CYAN}1.1${NC} Má»Ÿ Google Cloud Console:"
echo -e "    ${GREEN}https://console.cloud.google.com/${NC}\n"

read -p "$(echo -e ${CYAN}ÄÃ£ má»Ÿ Console? [Y/n]: ${NC})" CONFIRM1
if [[ ! $CONFIRM1 =~ ^[Yy]?$ ]]; then
    echo "Vui lÃ²ng má»Ÿ Google Cloud Console Ä‘á»ƒ tiáº¿p tá»¥c"
    exit 1
fi

echo -e "\n${CYAN}1.2${NC} Táº¡o Project má»›i:"
echo -e "    - Click [Select a project] á»Ÿ top bar"
echo -e "    - Click [NEW PROJECT]"
echo -e "    - Project name: ${GREEN}MIA-Dashboard${NC}"
echo -e "    - Click [CREATE]"
echo ""

read -p "$(echo -e ${CYAN}ÄÃ£ táº¡o project? [Y/n]: ${NC})" CONFIRM2

# Step 2: Enable APIs
echo -e "\n${YELLOW}â”â”â” BÆ¯á»šC 2: Enable Google Sheets API â”â”â”${NC}\n"
echo -e "${CYAN}2.1${NC} Trong project vá»«a táº¡o, vÃ o:"
echo -e "    ${GREEN}APIs & Services > Library${NC}\n"
echo -e "${CYAN}2.2${NC} Search vÃ  enable cÃ¡c API sau:"
echo -e "    âœ… Google Sheets API"
echo -e "    âœ… Google Drive API"
echo ""

read -p "$(echo -e ${CYAN}ÄÃ£ enable APIs? [Y/n]: ${NC})" CONFIRM3

# Step 3: Create Credentials
echo -e "\n${YELLOW}â”â”â” BÆ¯á»šC 3: Táº¡o Credentials â”â”â”${NC}\n"
echo -e "${CYAN}3.1${NC} VÃ o:"
echo -e "    ${GREEN}APIs & Services > Credentials${NC}\n"

echo -e "${CYAN}3.2${NC} Táº¡o API Key:"
echo -e "    - Click [+ CREATE CREDENTIALS]"
echo -e "    - Chá»n [API Key]"
echo -e "    - Copy API Key"
echo ""

read -p "$(echo -e ${CYAN}Nháº­p API Key: ${NC})" API_KEY

echo -e "\n${CYAN}3.3${NC} Táº¡o OAuth 2.0 Client ID:"
echo -e "    - Click [+ CREATE CREDENTIALS]"
echo -e "    - Chá»n [OAuth client ID]"
echo -e "    - Application type: [Web application]"
echo -e "    - Name: ${GREEN}MIA Dashboard${NC}"
echo -e "    - Authorized JavaScript origins:"
echo -e "      ${GREEN}http://localhost:5173${NC}"
echo -e "      ${GREEN}https://YOUR-DOMAIN.vercel.app${NC}"
echo -e "    - Click [CREATE]"
echo ""

read -p "$(echo -e ${CYAN}Nháº­p Client ID: ${NC})" CLIENT_ID
read -p "$(echo -e ${CYAN}Nháº­p Client Secret: ${NC})" CLIENT_SECRET

# Step 4: Create Spreadsheet
echo -e "\n${YELLOW}â”â”â” BÆ¯á»šC 4: Táº¡o Google Spreadsheet â”â”â”${NC}\n"
echo -e "${CYAN}4.1${NC} Má»Ÿ Google Sheets:"
echo -e "    ${GREEN}https://sheets.google.com/${NC}\n"
echo -e "${CYAN}4.2${NC} Táº¡o spreadsheet má»›i vá»›i tÃªn: ${GREEN}MIA-Dashboard-Data${NC}"
echo ""
echo -e "${CYAN}4.3${NC} Táº¡o cÃ¡c sheets sau:"
echo -e "    ğŸ“Š ${GREEN}Orders${NC} - Dá»¯ liá»‡u Ä‘Æ¡n hÃ ng"
echo -e "    ğŸ“… ${GREEN}Schedule${NC} - Lá»‹ch lÃ m viá»‡c"
echo -e "    ğŸ“¦ ${GREEN}Inventory${NC} - Nháº­p hÃ ng"
echo -e "    â° ${GREEN}Overtime${NC} - TÄƒng ca"
echo -e "    ğŸš› ${GREEN}Logistics${NC} - Váº­n chuyá»ƒn"
echo -e "    ğŸ’° ${GREEN}Costs${NC} - Chi phÃ­"
echo ""
echo -e "${CYAN}4.4${NC} Copy Spreadsheet ID tá»« URL:"
echo -e "    URL: https://docs.google.com/spreadsheets/d/${YELLOW}SPREADSHEET_ID${NC}/edit"
echo ""

read -p "$(echo -e ${CYAN}Nháº­p Spreadsheet ID: ${NC})" SPREADSHEET_ID

# Step 5: Update .env
echo -e "\n${YELLOW}â”â”â” BÆ¯á»šC 5: Cáº­p nháº­t Environment Variables â”â”â”${NC}\n"

if [ -f ".env" ]; then
    echo -e "${GREEN}Äang cáº­p nháº­t file .env...${NC}"
    
    # Backup old .env
    cp .env .env.backup
    
    # Update .env
    cat > .env << EOF
# Google Sheets API - Generated by setup-google-sheets.sh
VITE_GOOGLE_API_KEY=${API_KEY}
VITE_GOOGLE_CLIENT_ID=${CLIENT_ID}
VITE_GOOGLE_CLIENT_SECRET=${CLIENT_SECRET}
VITE_SPREADSHEET_ID=${SPREADSHEET_ID}

# App Config
VITE_APP_NAME=MIA.VN Dashboard
VITE_APP_VERSION=1.0.0
EOF
    
    echo -e "${GREEN}âœ… ÄÃ£ cáº­p nháº­t .env${NC}"
    echo -e "${YELLOW}âš ï¸  File .env cÅ© Ä‘Æ°á»£c backup táº¡i: .env.backup${NC}"
else
    echo -e "${YELLOW}âš ï¸  File .env khÃ´ng tá»“n táº¡i!${NC}"
    echo -e "Vui lÃ²ng cháº¡y setup.sh trÆ°á»›c"
    exit 1
fi

# Step 6: Setup Sample Data
echo -e "\n${YELLOW}â”â”â” BÆ¯á»šC 6: Thiáº¿t láº­p dá»¯ liá»‡u máº«u â”â”â”${NC}\n"
echo -e "${CYAN}Táº¡o cáº¥u trÃºc dá»¯ liá»‡u cho tá»«ng sheet:${NC}\n"

echo -e "${GREEN}ğŸ“Š Orders Sheet:${NC}"
echo -e "   A1: Date | B1: Channel | C1: Order ID | D1: Revenue | E1: Status"
echo ""

echo -e "${GREEN}ğŸ“… Schedule Sheet:${NC}"
echo -e "   A1: Date | B1: Employee | C1: Shift | D1: Hours | E1: Notes"
echo ""

echo -e "${GREEN}ğŸ“¦ Inventory Sheet:${NC}"
echo -e "   A1: Date | B1: Supplier | C1: Product | D1: Quantity | E1: Value | F1: Container"
echo ""

echo -e "${GREEN}â° Overtime Sheet:${NC}"
echo -e "   A1: Date | B1: Employee | C1: Hours | D1: Department | E1: Status"
echo ""

echo -e "${GREEN}ğŸš› Logistics Sheet:${NC}"
echo -e "   A1: Date | B1: Route | C1: Type | D1: Cost | E1: Products | F1: Status"
echo ""

echo -e "${GREEN}ğŸ’° Costs Sheet:${NC}"
echo -e "   A1: Month | B1: Category | C1: Amount | D1: Description | E1: Notes"
echo ""

# Step 7: Test Connection
echo -e "\n${YELLOW}â”â”â” BÆ¯á»šC 7: Test káº¿t ná»‘i â”â”â”${NC}\n"

cat > test-sheets-connection.js << 'TESTEOF'
// Test Google Sheets connection
const SPREADSHEET_ID = process.env.VITE_SPREADSHEET_ID;
const API_KEY = process.env.VITE_GOOGLE_API_KEY;

async function testConnection() {
  try {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?key=${API_KEY}`;
    const response = await fetch(url);
    const data = await response.json();
    
    if (data.spreadsheetId) {
      console.log('âœ… Káº¿t ná»‘i thÃ nh cÃ´ng!');
      console.log('ğŸ“Š Spreadsheet:', data.properties.title);
      console.log('ğŸ“„ Sheets:', data.sheets.map(s => s.properties.title).join(', '));
    } else {
      console.log('âŒ Káº¿t ná»‘i tháº¥t báº¡i:', data.error?.message);
    }
  } catch (error) {
    console.log('âŒ Lá»—i:', error.message);
  }
}

testConnection();
TESTEOF

echo -e "${CYAN}Äá»ƒ test káº¿t ná»‘i:${NC}"
echo -e "  ${GREEN}node test-sheets-connection.js${NC}\n"

# Step 8: Share Spreadsheet
echo -e "\n${YELLOW}â”â”â” BÆ¯á»šC 8: Chia sáº» Spreadsheet â”â”â”${NC}\n"
echo -e "${CYAN}Quan trá»ng: Chia sáº» spreadsheet vá»›i Service Account${NC}\n"
echo -e "1. Trong Google Sheets, click [Share]"
echo -e "2. Add email cá»§a Service Account (náº¿u cÃ³)"
echo -e "3. Hoáº·c set: ${GREEN}Anyone with the link can VIEW${NC}"
echo ""

read -p "$(echo -e ${CYAN}ÄÃ£ chia sáº» spreadsheet? [Y/n]: ${NC})" CONFIRM4

# Summary
echo -e "\n${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}ğŸ‰ HOÃ€N Táº¤T SETUP GOOGLE SHEETS API!${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"

echo -e "${CYAN}ğŸ“‹ ThÃ´ng tin Ä‘Ã£ cáº¥u hÃ¬nh:${NC}"
echo -e "  API Key: ${GREEN}${API_KEY:0:20}...${NC}"
echo -e "  Client ID: ${GREEN}${CLIENT_ID:0:30}...${NC}"
echo -e "  Spreadsheet ID: ${GREEN}${SPREADSHEET_ID}${NC}"
echo ""

echo -e "${CYAN}ğŸ”— Quick Links:${NC}"
echo -e "  ğŸ“Š Spreadsheet: ${GREEN}https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/edit${NC}"
echo -e "  âš™ï¸  Console: ${GREEN}https://console.cloud.google.com/apis/dashboard?project=${NC}"
echo ""

echo -e "${YELLOW}âš ï¸  LÆ°u Ã½ báº£o máº­t:${NC}"
echo -e "  - KHÃ”NG commit file .env lÃªn GitHub"
echo -e "  - Add credentials vÃ o Vercel Environment Variables"
echo -e "  - Giá»¯ API Key vÃ  Client Secret an toÃ n"
echo ""

echo -e "${CYAN}ğŸ“š TÃ i liá»‡u tham kháº£o:${NC}"
echo -e "  - Google Sheets API: ${GREEN}https://developers.google.com/sheets/api${NC}"
echo -e "  - OAuth 2.0: ${GREEN}https://developers.google.com/identity/protocols/oauth2${NC}"
echo ""

echo -e "${GREEN}âœ… Báº¡n cÃ³ thá»ƒ báº¯t Ä‘áº§u development vá»›i ./dev.sh${NC}\n"
